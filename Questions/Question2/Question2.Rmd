---
title: "Paged HTML Document"
author: "NF Katzke"
date: "November 2021"
# date: "`r Sys.Date()`"
bibliography: Tex/ref.bib       # Do not edit: Keep this naming convention and location.
output:
  pagedown::html_paged:
    # template: wp_paged.html
    # css: ['wp.css', 'wp-fonts.css', 'wp-page.css']
    css: ["Template/default-fonts-Texevier.css", "Template/default-page-Texevier.css", "Template/default-Texevier.css"]
    csl: Template/harvard-stellenbosch-university.csl # referencing format used.
    template: ["Template/paged-Texevier.html"]

    toc: true
    # change to true for a self-contained document, but it'll be a litte slower for Pandoc to render
    self_contained: TRUE
abstract: |
    This is an abstract. Much can be written here. Uncomment this line to go without an abstract.
    Abstracts have no spaces, but can have bullets.

    Bullets can be created as follows

    + You can add bullets, but do not add colons please.

    + Line breaks are also not permitted.

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
pacman::p_load(modelsummary, gt, knitr, kableExtra, tidyverse)
```

\newpage

# Introduction {-}

This template has been adapted from pagedown::html_paged and is intended to help you simply create HTML that has a readable (pdf) feel to it.

References are to be made as follows: [@fama1997] and @grinold2000 Such authors could also be referenced in brackets [@grinold2000] and together [@fama1997 \& @grinold2000]. Source the reference code from scholar.google.com by clicking on ``cite'' below article name. Then select BibTeX at the bottom of the Cite window, and proceed to copy and paste this code into your ref.bib file, located in the directory's Tex folder. Open this file in Rstudio for ease of management, else open it in your preferred Tex environment. Add and manage your article details here for simplicity - once saved, it will self-adjust in your paper.

> I suggest renaming the top line after \@article, as done in the template ref.bib file, to something more intuitive for you to remember. Do not change the rest of the code. Also, be mindful of the fact that bib references from google scholar may at times be incorrect. Reference Latex forums for correct bibtex notation.

Writing in Rmarkdown is surprizingly easy - see [this website](https://www.rstudio.com/wp-content/uploads/2015/03/rmarkdown-reference.pdf) cheatsheet for a summary on writing Rmd writing tips.

# Data  {-}

Notice how I used the curly brackets and dash to remove the numbering of the data section.

Discussion of data should be thorough with a table of statistics and ideally a figure.

In your tempalte folder, you will find a Data and a Code folder. In order to keep your data files neat, store all of them in your Data folder. Also, I strongly suggest keeping this Rmd file for writing and executing commands, not writing out long pieces of data-wrangling. In the example below, I simply create a ggplot template for scatter plot consistency. I suggest keeping all your data in a data folder.

<!-- The following is a code chunk. It must have its own unique name (after the r), or no name. After the comma follows commands for R which are self-explanatory. By default, the code and messages will not be printed in your pdf, just the output: -->

```{r}
Indexes <- read_rds("/Users/x/Downloads/28736907_Fin_Metrics/Questions/Question2/data/Cncy_Hedge_Assets.rds")
ZAR <- read_rds("/Users/x/Downloads/28736907_Fin_Metrics/Questions/Question2/data/Monthly_zar.rds")
```


```{r }

library(ggplot2)
library(gridExtra)
library(cowplot)
ZAR_YM <- ZAR %>% mutate(date = format(as.Date(date), "%Y-%m"))
USD_ZAR_returns <- ZAR_YM %>% mutate(Return_cur = value/lag(value) - 1)

Return <- Indexes %>% 
  mutate(date = format(as.Date(date), "%Y-%m")) %>% 
    full_join(., ZAR_YM, by = "date") %>% na.omit() %>% 
    mutate(J433_USD = J433/value) %>% mutate(ALBI_USD = ALBI/value) %>% 
  mutate(Global_Return = 0.18 * MSCI_ACWI + 0.12 * Bbg_Agg,
         Local_Return = 0.42 * J433_USD + 0.28 * ALBI_USD,
         Portfolio_Return = Global_Return + Local_Return) %>% 
    left_join(., USD_ZAR_returns, by = "date")

data_global <- Return %>% select(date, Global_Return, Return_cur) 

data_global$quadrant <- with(data_global, ifelse(Return_cur < 0 & Global_Return > 0, "Top-Left",
                            ifelse(Return_cur < 0 & Global_Return < 0, "Bottom-Left",
                            ifelse(Return_cur > 0 & Global_Return > 0, "Top-Right",
                            "Bottom-Right"))))
percentages <- round(prop.table(table(data_global$quadrant)) * 100)

x_min <- floor(min(data_global$Return_cur) * 100 / 5) * 5  # Round down to nearest 5%
x_max <- ceiling(max(data_global$Return_cur) * 100 / 5) * 5  # Round up to nearest 5%
y_min <- floor(min(data_global$Global_Return) * 100 / 5) * 5
y_max <- ceiling(max(data_global$Global_Return) * 100 / 5) * 5

p <- ggplot(data_global, aes(x = Return_cur * 100, y = Global_Return * 100)) +
  geom_point(alpha = 0.6) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  xlim(x_min, x_max) +
  ylim(y_min, y_max) +
  xlab("USD-ZAR Returns (%)") +
  ylab("60-40 Global Portfolio USD Returns (%)") +
  theme_bw() +
  theme(plot.margin = unit(c(1,1,2,1), "lines"))

p <- p + 
  annotate("rect", xmin = x_min, xmax = 0, ymin = y_min, ymax = y_max,
           fill = "yellow", alpha = 0.1) +
  annotate("rect", xmin = 0, xmax = x_max, ymin = y_min, ymax = y_max,
           fill = "green", alpha = 0.1)

p <- p +
  annotate("text", x = x_min * 0.7, y = y_max * 0.9, label = "Hedge works but amplifies volatility\n(strong negative correlation)", hjust = 0, size = 3) +
  annotate("text", x = x_min * 0.7, y = y_min * 0.7, label = "Best case for hedge:\nhigher return, lower volatility", hjust = 0, size = 3) +
  annotate("text", x = x_max * 0.05, y = y_min * 0.7, label = "Hedge removes\ncurrency cushion", hjust = 0, size = 3) +
  annotate("text", x = x_max * 0.05, y = y_max * 0.9, label = "Hedge throws away returns", hjust = 0, size = 3) +
  annotate("text", x = 0, y = y_max * 1.05, label = "Hedge is not free", vjust = -0.5, hjust = 0.5, size = 4, fontface = "bold")

quad_positions <- data.frame(
  quadrant = c("Top-Left", "Bottom-Left", "Top-Right", "Bottom-Right"),
  x = c(x_min * 0.5, x_min * 0.5, x_max * 0.5, x_max * 0.5),
  y = c(y_max * 0.5, y_min * 0.5, y_max * 0.5, y_min * 0.5),
  percentage = c(percentages["Top-Left"], percentages["Bottom-Left"], percentages["Top-Right"], percentages["Bottom-Right"])
)

p <- p +
  geom_text(data = quad_positions, aes(x = x, y = y, label = paste0(percentage, "%")), color = "black", size = 5, fontface = "bold")

# Add trend line (negative correlation)
p <- p + geom_smooth(method = "lm", se = FALSE, color = "blue")

# Add source attribution
p <- p +
  annotate("text", x = x_min, y = y_min - (y_max - y_min) * 0.1, label = "Source: Bloomberg. Calculation Satrix (31 December 2004 â€“ 31 January 2023).", hjust = 0, size = 3)

p_top <- ggplot(data_global, aes(x = Return_cur * 100)) +
  geom_density(fill = "green", alpha = 0.5) +
  theme_void() +
  xlim(x_min, x_max)

p_right <- ggplot(data_global, aes(x = Global_Return * 100)) +
  geom_density(fill = "red", alpha = 0.5) +
  theme_void() +
  xlim(y_min, y_max) +
  coord_flip()

p_top <- p_top + theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank())
p_right <- p_right + theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank())

# Arrange the plots
p_final <- plot_grid(p_top, NULL, p, ncol = 1, rel_heights = c(1, 0.1, 4))
p_combined <- plot_grid(p_final, p_right, ncol = 2, rel_widths = c(4, 1))

# Display the combined plot
print(p_combined)
```

Compare rolling 3 year hedged and unhedged
```{r}
# Load necessary libraries
library(dplyr)
library(lubridate)
library(readr)
library(zoo)
library(ggplot2)


# Ensure the date columns are in Date format
Indexes <- Indexes %>% mutate(date = as.Date(date))
ZAR <- ZAR %>% mutate(date = as.Date(date))

# Calculate local returns for ZAR-denominated indices (Capped SWIX and ALBI)
Indexes_Local_Returns <- Indexes %>%
  arrange(date) %>%
  mutate(
    J433_Return = J433 / lag(J433) - 1,
    ALBI_Return = ALBI / lag(ALBI) - 1
  )

# Calculate returns for USD-denominated indices (MSCI ACWI and Global Bond Aggregate)
Indexes_Local_Returns <- Indexes_Local_Returns %>%
  mutate(
    MSCI_ACWI_Return = MSCI_ACWI / lag(MSCI_ACWI) - 1,
    Bbg_Agg_Return = Bbg_Agg / lag(Bbg_Agg) - 1
  )

# Remove the first row with NA returns due to lag
Indexes_Local_Returns <- Indexes_Local_Returns %>% na.omit()

# Calculate the portfolio returns for the hedged portfolio (currency effects are neutralized)
Indexes_Local_Returns <- Indexes_Local_Returns %>%
  mutate(
    Global_Return = 0.18 * MSCI_ACWI_Return + 0.12 * Bbg_Agg_Return,
    Local_Return = 0.42 * J433_Return + 0.28 * ALBI_Return,
    Portfolio_Return_Hedged = Global_Return + Local_Return
  )


# Calculate rolling 12-month volatility for the hedged portfolio
Indexes_Local_Returns <- Indexes_Local_Returns %>%
  arrange(date) %>%
  mutate(
    Rolling_Vol_Hedged = rollapply(Portfolio_Return_Hedged, width = 12, FUN = sd, fill = NA, align = "right") * sqrt(12)
  )

# Plotting the rolling volatility over time
ggplot(Indexes_Local_Returns, aes(x = date, y = Rolling_Vol_Hedged)) +
  geom_line(color = "blue") +
  labs(title = "12-Month Rolling Volatility of Hedged Portfolio",
       x = "Date",
       y = "Rolling Volatility") +
  theme_minimal()

```


```{r}
# Load necessary libraries
library(dplyr)
library(lubridate)
library(readr)
library(zoo)
library(ggplot2)

# Load the data


# Ensure the date columns are in Date format
Indexes <- Indexes %>% mutate(date = as.yearmon(date))
ZAR <- ZAR %>% mutate(date = as.yearmon(date))

# Calculate exchange rate returns (currency returns)
ZAR <- ZAR %>%
  arrange(date) %>%
  mutate(Return_cur = value / lag(value) - 1)

# Merge Indexes with exchange rates
Data_Unhedged <- Indexes %>%
  left_join(ZAR, by = "date") %>%
  arrange(date)

# Convert ZAR-denominated indices to USD including currency effects
Data_Unhedged <- Data_Unhedged %>%
  mutate(
    J433_USD = J433 / value,
    ALBI_USD = ALBI / value
  )

# Calculate returns for all assets including currency effects
Data_Unhedged <- Data_Unhedged %>%
  mutate(
    MSCI_ACWI_Return = MSCI_ACWI / lag(MSCI_ACWI) - 1,
    Bbg_Agg_Return = Bbg_Agg / lag(Bbg_Agg) - 1,
    J433_USD_Return = J433_USD / lag(J433_USD) - 1,
    ALBI_USD_Return = ALBI_USD / lag(ALBI_USD) - 1
  )

# Remove NA values due to lag
Data_Unhedged <- Data_Unhedged %>% na.omit()

# Define portfolio weights
# Equity: 60% total
#   - 70% local equities (Capped SWIX): 0.42
#   - 30% global equities (MSCI ACWI): 0.18
# Bonds: 40% total
#   - 70% local bonds (ALBI): 0.28
#   - 30% global bonds (Global Bond Aggregate): 0.12

# Calculate portfolio returns for the unhedged portfolio
Data_Unhedged <- Data_Unhedged %>%
  mutate(
    Global_Return = 0.18 * MSCI_ACWI_Return + 0.12 * Bbg_Agg_Return,
    Local_Return = 0.42 * J433_USD_Return + 0.28 * ALBI_USD_Return,
    Portfolio_Return_Unhedged = Global_Return + Local_Return
  )

# Calculate rolling 12-month volatility for the unhedged portfolio
Data_Unhedged <- Data_Unhedged %>%
  arrange(date) %>%
  mutate(
    Rolling_Vol_Unhedged = rollapply(Portfolio_Return_Unhedged, width = 12, FUN = sd, fill = NA, align = "right") * sqrt(12)
  )

# Plotting the rolling volatility over time
ggplot(Data_Unhedged, aes(x = date, y = Rolling_Vol_Unhedged)) +
  geom_line(color = "red") +
  labs(title = "12-Month Rolling Volatility of Unhedged Portfolio",
       x = "Date",
       y = "Rolling Volatility") +
  theme_minimal()

```

```{r}
filtered_hedged <- Indexes_Local_Returns %>% select(date, Portfolio_Return_Hedged)
filtered_unhedged <- Data_Unhedged %>% select(date, Portfolio_Return_Unhedged) 
chart.CumReturns(xts_hedged)
xts_unhedged <- filtered_unhedged %>% tbl_xts()
chart.CumReturns(xts_unhedged)
```

#  Methodology \label{Meth} {-}

## Subsection {-}
Ideally do not overuse subsections. It equates to bad writing.^[This is an example of a footnote by the way. Something that should also not be overused.]

## Math section {-}

Equations should be written as such:

\begin{align}
\beta = \sum_{i = 1}^{\infty}\frac{\alpha^2}{\sigma_{t-1}^2} \label{eq1} \\
\int_{x = 1}^{\infty}x_{i} = 1 \notag
\end{align}

If you would like to see the equations as you type in Rmarkdown, use $ symbols instead (see this for yourself by adjusted the equation):

$$
\beta = \sum_{i = 1}^{\infty}\frac{\alpha^2}{\sigma_{t-1}^2} \\
\int_{x = 1}^{\infty}x_{i} = 1
$$

Writing nice math requires practice. Note I used a forward slashes to make a space in the equations. I can also align equations using  __\&__, and set to numbering only the first line. Now I will have to type ``begin equation'' which is a native \LaTeX command. Here follows a more complicated equation:


\begin{align}
	y_t &= c + B(L) y_{t-1} + e_t   \label{eq2}    \\ \notag
	e_t &= H_t^{1/2}  z_t ; \quad z_t \sim  N(0,I_N) \quad \& \quad H_t = D_tR_tD_t \\ \notag
		D_t^2 &= {\sigma_{1,t}, \dots, \sigma_{N,t}}   \\ \notag
		\sigma_{i,t}^2 &= \gamma_i+\kappa_{i,t}  v_{i, t-1}^2 +\eta_i  \sigma_{i, t-1}^2, \quad \forall i \\ \notag
		R_{t, i, j} &= {diag(Q_{t, i, j}}^{-1}) . Q_{t, i, j} . diag(Q_{t, i, j}^{-1})  \\ \notag
		Q_{t, i, j} &= (1-\alpha-\beta)  \bar{Q} + \alpha  z_t  z_t'  + \beta  Q_{t, i, j} \notag
\end{align}

Note that above we've aligned the equations by the equal signs. I also want only one tag, and I create spaces using ``quads''.

See if you can figure out how to do complex math using the two examples provided.

<!-- $$ -->
<!-- This is a commented out section in the writing part. -->
<!-- Comments are created by highlighting text, amnd pressing CTL+C -->
<!-- \\begin{align} -->
<!-- \\beta = \\alpha^2 -->
<!-- \end{align} -->
<!-- $$ -->

## Results {-}

Tables can be included as follows. Use the _xtable_ (or kable) package for tables. Table placement = H implies Latex tries to place the table Here, and not on a new page (there are, however, very many ways to skin this cat. Luckily there are many forums online!).

```{r table-1, echo=TRUE, message=FALSE, warning=FALSE, results="asis"}
library(knitr)
library(kableExtra)

data <- mtcars[1:5,] %>% tibble::as_tibble()

table <- kable(data, row.names = TRUE,
      caption = 'Table with kable() and kablestyling()',
      format = "html", booktabs = T) %>%
        kable_styling(full_width = T,
                      latex_options = c("striped",
                                        "scale_down",
                                        "HOLD_position"),
                      font_size = 13)
table
```

To reference calculations __in text__, _do this:_ From table \@ref(tab:table-1) we see the average value of mpg is `r mean(mtcars[1:5,]$mpg)`. Notice the use of table-2 in the chunk name. That's the good stuff.

\newpage


# Model summary


Check [this](https://vincentarelbundock.github.io/modelsummary/articles/modelsummary.html) link out for more. Note this package also plays nicely with gt, kableExtra, etc.

```{r}

library(modelsummary);library(gt)

# modelsummary works well with gt:

Tab <-

datasummary_skim(swiss,
type="numeric",
 histogram=T,
 title = "Summary: Numeric variables", output = "gt") %>%

        # column labels
    tab_spanner(label = 'Statistics', columns = c("Mean", "SD")) %>%
    tab_spanner(label = 'Quantiles', columns = starts_with("P")) %>%
    # footnote
    tab_footnote(footnote = md("A very **important** Footnote."),
                 locations = cells_body(rows = 3, columns = 1)) %>%

    tab_options(data_row.padding = px(4),table.width = pct(60),
            column_labels.font.size = pct(100),
            column_labels.vlines.width = 1, table.font.size = pct(60))

Tab
```


# References {-}

<div id="refs"></div>


# Appendix {-}

## Appendix A {-}

Some appendix information here

## Appendix B {-}



